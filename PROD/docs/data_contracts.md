
# Data Contracts & API Specifications

This document defines the strict data structures (JSON) used to communicate between the Figma Plugin Client, the Controller, and the Supabase Backend.

---

## 1. Figma Node Sanitization (Client -> Backend)

Figma Nodes are complex objects with circular references. Before sending them to AI or Backend, they MUST be sanitized into this `SimpNode` format.

### Interface `SimpNode`
```typescript
interface SimpNode {
  id: string;
  name: string;
  type: "FRAME" | "TEXT" | "RECTANGLE" | "INSTANCE" | "COMPONENT";
  layoutMode?: "NONE" | "HORIZONTAL" | "VERTICAL";
  fills: string[]; // Hex codes only
  width: number;
  height: number;
  // For Text Nodes
  text?: string;
  font?: string;
  fontSize?: number;
  // For Instances
  mainComponentId?: string;
  // Children (Recursive, max depth 4)
  children?: SimpNode[];
}
```

### Sanitization Logic (Pseudo-code)
```typescript
function sanitize(node): SimpNode {
  // 1. Ignore invisible nodes
  // 2. Convert RGBA to Hex
  // 3. Truncate text > 100 chars
  // 4. Recursively map children
  return { ... }
}
```

---

## 2. Supabase Edge Functions

All backend calls go through `https://<project>.supabase.co/functions/v1/<function-name>`.

### Function: `audit-scan`
*   **Method**: POST
*   **Auth**: Bearer Token (Supabase Auth)
*   **Request Body**:
    ```json
    {
      "nodes": [SimpNode], 
      "plan": "PRO" 
    }
    ```
*   **Response**:
    ```json
    {
      "score": 85,
      "issues": [
        {
          "id": "uuid",
          "severity": "HIGH",
          "message": "Contrast ratio failure",
          "layerId": "node-123",
          "suggestion": "Change text color to #000000"
        }
      ]
    }
    ```

### Function: `generate-component`
*   **Method**: POST
*   **Request Body**:
    ```json
    {
      "prompt": "A dark mode card for crypto stats",
      "context": {
        "tokens": ["color.primary", "spacing.sm"],
        "components": ["Card", "Button"]
      }
    }
    ```
*   **Response**:
    Returns a specialized JSON that the plugin controller interprets to draw nodes.
    ```json
    {
      "layout": "VERTICAL",
      "children": [
        { "component": "Card", "props": { "variant": "outlined" } }
      ]
    }
    ```

---

## 3. Deep Sync & Drift Payloads

To detect drift, we compare signatures.

### The "Drift Signature"
A string generated by hashing the component's critical structure.

```typescript
// Comparison Logic
const figmaSig = sha256({
  name: node.name,
  props: node.componentProperties, // e.g. { "state": "hover", "icon": "true" }
  styles: extractCriticalStyles(node) // padding, gap, fill
});

const codeSig = fetchFromStorybook(node.name).signature;

if (figmaSig !== codeSig) {
  status = "DRIFT";
}
```

---

## 4. AI Prompt Structures (System Instructions)

### For Auditing
> "You are a Design System Auditor. Analyze the provided JSON structure. Your goal is to find inconsistencies.
> Rules:
> 1. If `fills` contains a Hex code not present in the `valid_tokens` list, flag as 'Hardcoded Value'.
> 2. If a Frame named 'Button' contains no text node, flag as 'Empty Button'.
> Return ONLY JSON format matching the `AuditIssue` schema."

### For Code Generation (RAG)
> "You are a Frontend Engineer. Convert this JSON layout into React + Tailwind.
> CRITICAL:
> - Use `className` for styling.
> - Replace raw hex `#ff90e8` with `var(--color-primary)`.
> - Do not invent classes. Use standard Tailwind."
